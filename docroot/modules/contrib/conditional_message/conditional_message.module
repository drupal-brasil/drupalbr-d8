<?php

/**
 * @file
 * Display a custom message depending on given conditions.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function conditional_message_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.conditional_message':
      $text = file_get_contents(dirname(__FILE__) . "/README.md");
      if (!\Drupal::moduleHandler()->moduleExists('markdown')) {
        $output = '<pre>' . $text . '</pre>';
      }
      else {
        // Use the Markdown filter to render the README.
        $filter_manager = \Drupal::service('plugin.manager.filter');
        $settings = \Drupal::configFactory()->get('markdown.settings')->getRawData();
        $config = ['settings' => $settings];
        $filter = $filter_manager->createInstance('markdown', $config);
        $output = $filter->process($text, 'en');
      }

      $output .= t('<p>See the <a href=":project-page">project page</a> on Drupal.org for more information.</p>',
        [
          ':project-page' => 'https://www.drupal.org/project/conditional_message',
        ]);
      return $output;
  }
}

/**
 * Implements hook_page_attachments().
 */
function conditional_message_page_attachments(array &$page) {

  $config = \Drupal::config('conditional_message.settings');

  // Send confg info to JS.
  // TODO (?) add display, paht, types to JS settings.
  $page['#attached']['drupalSettings']['conditional_message'] = [
    'base_path' => base_path(),
    'options' => $config->get('conditional_message_options'),
    'message' => $config->get('conditional_message_text'),
    'bg_color' => $config->get('conditional_message_bg_color'),
    'color' => $config->get('conditional_message_color'),
    'position' => $config->get('conditional_message_position'),
    'target' => $config->get('conditional_message_target'),
  ];

  // TODO is there a way to not add the library on every page?
  $page['#attached']['library'][] = 'conditional_message/conditional-message';
}
